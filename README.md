# flat_color_quantization
This is an experimental app based on personal interests.      

# Run 
*Only works for few types*  
    
```
# Gradio
python flat_color_gradio.py

# Console with post-denoising
python flat_color_cli.py --input ai.png --output ai_flat_de.png --n_colors 256 --upscale 2.0 --temperature 2.0 --spatial_scale 40 --upscale_model RealESRGAN_x4plus_anime_6B.pth --denoise 4,4,5,15
```

| Argument | Default / Recommend Value | Comment |
| --- | --- | --- |
| input | | Required |
| output | | Required |
| n_colors | 256 (16~4096) | High color count |
| temperature | 2.0 (1~5) | Higher temperature to enhance soft assignment |
| spatial_scale | 60 (40~500) | arger spatial weight to promote large region formation |
| sharpen_strength| Disable (1~2) | Post-sharpen |
| block_size| 512 (64~1024) | Block processing to save VRAM |
| upscale | Disable (1.5~8.0) | Upscale input image before GPU soft |
| upscale_model | Upscale (NMKD/ESRGAN/RealESRGAN) model path (.safetensors/.pth) | Use cv2 fallback resize if not present |
| denoise | 4,4,5,15 | Pose-denoising before Post-sharpen `h,hColor,templateWindowSize,searchWindowSize` |


# Example 
<table align="center">
  <thead>
    <tr>
      <th>Before</th>
      <th>After</th>
      <th>After with Denois</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td width="33%"><img src="https://github.com/mirabarukaso/flat_color_quantization/blob/main/imgs/ai_before.png" width="200"></td>
      <td width="33%"><img src="https://github.com/mirabarukaso/flat_color_quantization/blob/main/imgs/ai_after.png" width="200"></td>
      <td width="33%"><img src="https://github.com/mirabarukaso/flat_color_quantization/blob/main/imgs/ai_after_de.png" width="200"></td>
    </tr>
    <tr>
      <td width="33%"><img src="https://github.com/mirabarukaso/flat_color_quantization/blob/main/imgs/example_before.png" width="200"></td>
      <td width="33%"><img src="https://github.com/mirabarukaso/flat_color_quantization/blob/main/imgs/example_after.png" width="200"></td>
      <td width="33%"><img src="https://github.com/mirabarukaso/flat_color_quantization/blob/main/imgs/example_after_de.png" width="200"></td>
    </tr>
    <tr>
      <td width="33%" style="text-align:left;">The orignal image generated by <a href="https://github.com/mirabarukaso/character_select_stand_alone_app">SAA</a> </td>
      <td width="33%" style="text-align:left;"><code>--n_colors 256 --upscale 2.0 --temperature 2.0 --spatial_scale 40 --upscale_model RealESRGAN_x4plus_anime_6B.pth</code></td>
      <td width="33%" style="text-align:left;"><code>--n_colors 256 --upscale 2.0 --temperature 2.0 --spatial_scale 40 --upscale_model RealESRGAN_x4plus_anime_6B.pth --denoise 4,4,5,15</code></td>
    </tr>
    <tr>
      <td width="33%"><img src="https://github.com/mirabarukaso/flat_color_quantization/blob/main/imgs/ai2_before.png" width="200"></td>
      <td width="33%"><img src="https://github.com/mirabarukaso/flat_color_quantization/blob/main/imgs/ai2_after.png" width="200"></td>
      <td width="33%"><img src="https://github.com/mirabarukaso/flat_color_quantization/blob/main/imgs/ai2_after_de.png" width="200"></td>
    </tr>
    <tr>
      <td width="33%"><img src="https://github.com/mirabarukaso/flat_color_quantization/blob/main/imgs/example2_before.png" width="200"></td>
      <td width="33%"><img src="https://github.com/mirabarukaso/flat_color_quantization/blob/main/imgs/example2_after.png" width="200"></td>
      <td width="33%"><img src="https://github.com/mirabarukaso/flat_color_quantization/blob/main/imgs/example2_after_de.png" width="200"></td>
    </tr>
    <tr>
      <td width="33%" style="text-align:left;">The orignal image generated by <a href="https://github.com/mirabarukaso/character_select_stand_alone_app">SAA</a></td>
      <td width="33%" style="text-align:left;"><code>--n_colors 256 --upscale 2.0 --temperature 2.0 --spatial_scale 60 --upscale_model RealESRGAN_x4plus_anime_6B.pth</code></td>
      <td width="33%" style="text-align:left;"><code>--n_colors 256 --upscale 2.0 --temperature 2.0 --spatial_scale 60 --upscale_model RealESRGAN_x4plus_anime_6B.pth --denoise 4,4,5,15</code></td>
    </tr>
    <tr>
      <td width="33%"><img src="https://github.com/mirabarukaso/flat_color_quantization/blob/main/imgs/ai3_before.png" width="200"></td>
      <td width="33%"><img src="https://github.com/mirabarukaso/flat_color_quantization/blob/main/imgs/ai3_after.png" width="200"></td>
      <td width="33%"><img src="https://github.com/mirabarukaso/flat_color_quantization/blob/main/imgs/ai3_after_de.png" width="200"></td>
    </tr>
    <tr>
      <td width="33%"><img src="https://github.com/mirabarukaso/flat_color_quantization/blob/main/imgs/example3_before.png" width="200"></td>
      <td width="33%"><img src="https://github.com/mirabarukaso/flat_color_quantization/blob/main/imgs/example3_after.png" width="200"></td>
      <td width="33%"><img src="https://github.com/mirabarukaso/flat_color_quantization/blob/main/imgs/example3_after_de.png" width="200"></td>
    </tr>
    <tr>
      <td width="33%" style="text-align:left;">The orignal image generated by <a href="https://github.com/mirabarukaso/character_select_stand_alone_app">SAA</a></td>
      <td width="33%" style="text-align:left;"><code>--n_colors 192 --seed 3425804130 --upscale 2.0 --temperature 2.0 --spatial_scale 60 --upscale_model RealESRGAN_x4plus_anime_6B.pth</code></td>
      <td width="33%" style="text-align:left;"><code>--n_colors 192 --seed 3425804130 --upscale 2.0 --temperature 2.0 --spatial_scale 60 --upscale_model RealESRGAN_x4plus_anime_6B.pth --denoise 4,9,7,27</code></td>
    </tr>
  </tbody>
</table>

# Image Color Transfer
Please refer to [Image Color Transfer](https://github.com/mirabarukaso/ComfyUI_Mira#image-color-transfer) for more details about Image Color Transfer.      
